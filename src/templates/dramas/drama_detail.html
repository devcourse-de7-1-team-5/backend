{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ drama.title }}</title>
  <link rel="stylesheet" href="{% static 'dramas/drama_detail.css' %}">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  
</head>
<body>
  <div class="container">
    <h1>{{ drama.title }}</h1>

    <div class="drama-info-wrapper">
      <div class="drama-info-text">
        <!-- ë“œë¼ë§ˆ ê¸°ë³¸ ì •ë³´ë“¤ -->
        <p>
          <strong>ë°©ì†¡ì‚¬:</strong> {{ drama.channel }}
        </p>
        <p>
          <strong>ë°©ì˜ ê¸°ê°„:</strong> {{ drama.start_date }} ~ {{ drama.end_date }}
        </p>
        <p class="genre">
          <strong>ì¥ë¥´:</strong>
            {% if drama.genres.all %}
                {% for g in drama.genres.all %}
                    {{ g.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            {% else %}
                ì •ë³´ ì—†ìŒ
            {% endif %}
        </p>

        {% if drama.description %}
          <p>{{ drama.description }}</p>
        {% endif %}
        <!-- ë” ë„£ì„ ì •ë³´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€ -->
      </div>
    
      {% if drama.img_url %}
        <div class="drama-info-image">
          <img src="{{ drama.img_url }}" alt="{{ drama.title }}">
        </div>
      {% else %}
        <div class="drama-info-image">
          <img src="{% static 'dramas/images/default_thumb.jpg' %}" alt="{{ drama.title }}">
        </div>
      {% endif %}
    </div>

    <!-- {% if drama.img_url %}
      <img src="{{ drama.img_url }}" alt="{{ drama.title }}">
    {% else %}
      <img src="{% static 'dramas/images/default_thumb.jpg' %}" alt="No Image">
    {% endif %}

    {% if drama.description %}
      <p>{{ drama.description }}</p>
    {% endif %} -->

    <hr>

    <!-- ê·¸ë˜í”„ ê·¸ë¦´ ì˜ì—­ -->
    <h2>ì‹œì²­ë¥  ê·¸ë˜í”„</h2>
    <canvas id="ratingChart" width="600" height="300"></canvas>
    
    <hr>

    <!-- ì—í”¼ì†Œë“œ ëª©ë¡ -->
    <h2>ì—í”¼ì†Œë“œ ëª©ë¡</h2>
    {% if drama.episodes %}
      <ul class="episode-list">
        {% for ep in drama.episodes.all %}
          <li class="episode-item">
            <h3>{{ ep.episode_no }}íšŒ ({{ ep.date }})</h3>
            <p><strong>ì‹œì²­ë¥ :</strong> {{ ep.rating }}%</p>
            <p>{{ ep.synopsis }}</p>
            <p>
              ğŸ”— <a href="{{ ep.source_url }}" target="_blank">ë„¤ì´ë²„ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°</a>
            </p>

            <!-- ë”ë³´ê¸°: ë‰´ìŠ¤ ëª©ë¡ -->
            <details class="news-block">
              <summary>
                ë”ë³´ê¸° (ë‰´ìŠ¤ {{ ep.drama_news.count }}ê±´)
              </summary>
            <ul class="news-list">
              {% for n in ep.drama_news.all %}
                <li class="news-item">
                  <a href="{{ n.link }}" target="_blank">{{ n.title }}</a><br>
                  <strong>- ({{ n.press }}) {{ n.date }}</strong><br>
                  <!-- {% if n.content %}<p>{{ n.content }}</p>{% endif %} -->
                </li>
              {% empty %}
                <li>ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
            {% endfor %}
            </ul>
            </details>

          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>ë“±ë¡ëœ ì—í”¼ì†Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  <!-- ê·¸ë˜í”„ ìŠ¤í¬ë¦½íŠ¸ (body ë§¨ ì•„ë˜ì— ë‘ëŠ” ê²Œ ì¼ë°˜ì ) -->
  <script>
    // ì¥ê³  í…œí”Œë¦¿ ë°ì´í„° â†’ ìë°”ìŠ¤í¬ë¦½íŠ¸ ë°°ì—´ë¡œ ë³€í™˜
    const labels = [{% for ep in drama.episodes.all %} {{ ep.episode_no }}, {% endfor %}];
    const data = [{% for ep in drama.episodes.all %} {{ ep.rating }}, {% endfor %}];
    
    // const episodes = JSON.parse(document.getElementById("episodes-data").textContent);

    // const labels = episodes.map(ep => ep.episode_no);
    // const data = episodes.map(ep => ep.rating);

    const ctx = document.getElementById('ratingChart').getContext('2d');
    const ratingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels, // xì¶• (íšŒì°¨ ë²ˆí˜¸)
        datasets: [{
          label: 'ì‹œì²­ë¥  (%)',
          data: data,    // yì¶• (ì‹œì²­ë¥ )
          borderColor: 'blue',
          backgroundColor: 'rgba(0, 0, 255, 0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  </script>
</body>
</html>
