{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ drama.title }}</title>
  <link rel="stylesheet" href="{% static 'dramas/drama_detail.css' %}">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  
</head>
<body>
  <div class="container">
    <h1>{{ drama.title }}</h1>

    <div class="drama-info-wrapper">
      <div class="drama-info-text">
        <!-- 드라마 기본 정보들 -->
        <p>
          <strong>방송사:</strong> {{ drama.channel }}
        </p>
        <p>
          <strong>방영 기간:</strong> {{ drama.start_date }} ~ {{ drama.end_date }}
        </p>
        <p class="genre">
          <strong>장르:</strong>
            {% if drama.genres.all %}
                {% for g in drama.genres.all %}
                    {{ g.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            {% else %}
                정보 없음
            {% endif %}
        </p>

        {% if drama.description %}
          <p>{{ drama.description }}</p>
        {% endif %}
        <!-- 더 넣을 정보 있다면 여기에 추가 -->
      </div>
    
      {% if drama.img_url %}
        <div class="drama-info-image">
          <img src="{{ drama.img_url }}" alt="{{ drama.title }}">
        </div>
      {% else %}
        <div class="drama-info-image">
          <img src="{% static 'dramas/images/default_thumb.jpg' %}" alt="{{ drama.title }}">
        </div>
      {% endif %}
    </div>

    <!-- {% if drama.img_url %}
      <img src="{{ drama.img_url }}" alt="{{ drama.title }}">
    {% else %}
      <img src="{% static 'dramas/images/default_thumb.jpg' %}" alt="No Image">
    {% endif %}

    {% if drama.description %}
      <p>{{ drama.description }}</p>
    {% endif %} -->

    <hr>

    <!-- 그래프 그릴 영역 -->
    <h2>시청률 그래프</h2>
    <canvas id="ratingChart" width="600" height="300"></canvas>
    
    <hr>

    <!-- 에피소드 목록 -->
    <h2>에피소드 목록</h2>
    {% if drama.episodes %}
      <ul class="episode-list">
        {% for ep in drama.episodes.all %}
          <li class="episode-item">
            <h3>{{ ep.episode_no }}회 ({{ ep.date }})</h3>
            <p><strong>시청률:</strong> {{ ep.rating }}%</p>
            <p>{{ ep.synopsis }}</p>
            <p>
              🔗 <a href="{{ ep.source_url }}" target="_blank">네이버 검색 결과 보기</a>
            </p>

            <!-- 더보기: 뉴스 목록 -->
            <details class="news-block">
              <summary>
                더보기 (뉴스 {{ ep.drama_news.count }}건)
              </summary>
            <ul class="news-list">
              {% for n in ep.drama_news.all %}
                <li class="news-item">
                  <a href="{{ n.link }}" target="_blank">{{ n.title }}</a><br>
                  <strong>- ({{ n.press }}) {{ n.date }}</strong><br>
                  <!-- {% if n.content %}<p>{{ n.content }}</p>{% endif %} -->
                </li>
              {% empty %}
                <li>등록된 뉴스가 없습니다.</li>
            {% endfor %}
            </ul>
            </details>

          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>등록된 에피소드가 없습니다.</p>
    {% endif %}
  </div>

  <!-- 그래프 스크립트 (body 맨 아래에 두는 게 일반적) -->
  <script>
    // 장고 템플릿 데이터 → 자바스크립트 배열로 변환
    const labels = [{% for ep in drama.episodes.all %} {{ ep.episode_no }}, {% endfor %}];
    const data = [{% for ep in drama.episodes.all %} {{ ep.rating }}, {% endfor %}];
    
    // const episodes = JSON.parse(document.getElementById("episodes-data").textContent);

    // const labels = episodes.map(ep => ep.episode_no);
    // const data = episodes.map(ep => ep.rating);

    const ctx = document.getElementById('ratingChart').getContext('2d');
    const ratingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels, // x축 (회차 번호)
        datasets: [{
          label: '시청률 (%)',
          data: data,    // y축 (시청률)
          borderColor: 'blue',
          backgroundColor: 'rgba(0, 0, 255, 0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  </script>
</body>
</html>
