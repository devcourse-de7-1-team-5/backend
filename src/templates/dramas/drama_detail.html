{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ drama.title }}</title>
  <link rel="stylesheet" href="{% static 'dramas/drama_detail.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sort-links {
      margin-bottom: 20px;
    }

    .sort-btn {
      display: inline-block;
      padding: 5px 12px;
      margin-right: 10px;
      text-decoration: none;
      color: #333;
      background-color: #f0f0f0;
      border-radius: 5px;
      transition: background-color 0.2s;
    }

    .sort-btn:hover {
      background-color: #ddd;
    }

    .sort-btn.active {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border: 1px solid #0056b3;
    }

    .episode-item {
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 5px;
    }

    .highlight {
      background-color: rgba(255, 255, 0, 0.3);
      transition: background-color 0.5s;
    }
  </style>
</head>
<body>
<div class="container" style="width: 100%;">
  <h1><a href="/dramas">ë“œë¼ë§ˆ</a> / {{ drama.title }}</h1>

  <!-- ë“œë¼ë§ˆ ê¸°ë³¸ ì •ë³´ -->
  <div
      style=" display: flex; flex-flow: row nowrap; justify-content: space-between; align-items: flex-start;">
    <div
        style="display: flex; flex-flow: column nowrap; justify-content: flex-start; align-items: center;">

      <div>
      {% if drama.img_url %}
        <img src="{{ drama.img_url }}" alt="{{ drama.title }}"
             style="max-width: 300px; height: auto;">
      {% else %}
        <img src="{% static 'dramas/images/default_thumb.jpg' %}" alt="{{ drama.title }}">
      {% endif %}
    </div>
      <div
          style="display: flex; flex-flow: column nowrap; justify-content: space-between; align-items: flex-start;">
        <div>

          <p><strong>ë°©ì†¡ì‚¬:</strong> {{ drama.channel }}</p>
          <p><strong>ë°©ì˜ ê¸°ê°„</strong></p>
          <p>{{ drama.start_date }} ~ {{ drama.end_date }}</p>
        </div>
        <p class="genre">
          <strong>ì¥ë¥´:</strong>
        <div style="display: flex; flex-flow: row wrap">

          {% if drama.genres.all %}
            {% for g in drama.genres.all %}
              <button
                  onClick="window.location='{% url 'drama-list' %}?genre={{ g.name }}';"
                  style="margin: 2px; padding: 5px 10px; border: none; background-color: #e0e0e0; border-radius: 5px; cursor: pointer;">


                {{ g.name }}{% if not forloop.last %}{% endif %}
              </button>

            {% endfor %}
          {% else %} ì •ë³´ ì—†ìŒ {% endif %}
        </div>
        </p>

      </div>
    </div>
    <div
        style=" display: flex ; flex-flow: column nowrap; justify-content: flex-start; align-items: flex-start; flex-grow: 1">
      <h2>ì‹œì²­ë¥  / ë‰´ìŠ¤ ìˆ˜ ê·¸ë˜í”„</h2>
      <canvas id="ratingChart" width="520px" height="300px" style="flex: 1 1 auto"></canvas>
    </div>
  </div>
  {% if drama.description %}<p>{{ drama.description }}</p>{% endif %}
  <hr>
  <div class="sort-links">
    <a href="?order_by=episode_no"
       class="sort-btn {% if current_order == 'episode_no' %}active{% endif %}">íšŒì°¨ ì˜¤ë¦„ì°¨ìˆœ</a>
    <a href="?order_by=-rating"
       class="sort-btn {% if current_order == '-rating' %}active{% endif %}">ì‹œì²­ë¥  ë†’ì€ ìˆœ</a>
    <a href="?order_by=-news_count"
       class="sort-btn {% if current_order == '-news_count' %}active{% endif %}">ë‰´ìŠ¤ ë§ì€ ìˆœ</a>
  </div>
  <!-- ì—í”¼ì†Œë“œ ëª©ë¡ -->
  <h2>ì—í”¼ì†Œë“œ ëª©ë¡</h2>
  {% if drama.episodes %}
    <ul class="episode-list">
      {% for ep in drama.episodes.all %}
        <li class="episode-item" id="episode-{{ ep.episode_no }}">
          <h3>{{ ep.episode_no }}íšŒ ({{ ep.date }})</h3>
          <p><strong>ì‹œì²­ë¥ :</strong> {{ ep.rating }}%</p>
          <p>{{ ep.synopsis }}</p>
          <p>ğŸ”— <a href="{{ ep.source_url }}" target="_blank">ë„¤ì´ë²„ ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°</a></p>

          <details class="news-block">
            <summary>ë”ë³´ê¸° (ë‰´ìŠ¤ {{ ep.drama_news.count }}ê±´)</summary>
            <ul class="news-list">
              {% for n in ep.drama_news.all %}
                <li class="news-item">
                  <a href="{{ n.link }}" target="_blank">{{ n.title }}</a><br>
                  <strong>- ({{ n.press }}) {{ n.date }}</strong>
                </li>
              {% empty %}
                <li>ë“±ë¡ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
              {% endfor %}
            </ul>
          </details>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>ë“±ë¡ëœ ì—í”¼ì†Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</div>

<script>
  // Xì¶•: í•­ìƒ íšŒì°¨ ìˆœ
  const episodeNos = [{% for ep in drama.episodes.all|dictsort:"episode_no" %}{{ ep.episode_no }},
    {% endfor %}];
  const airingDates = [{% for ep in drama.episodes.all|dictsort:"episode_no" %}'{{ ep.date }}',
  {% endfor %}];

  // ì •ë ¬ ê¸°ì¤€ì— ë”°ë¼ Yì¶• ê°’ ë°°ì—´ ìƒì„±
  const ratingsMap = {};
  const newsMap = {};
  {% for ep in drama.episodes.all %}
    ratingsMap[{{ ep.episode_no }}] = {{ ep.rating|default:0 }};
    newsMap[{{ ep.episode_no }}] = {{ ep.news_count|default:0 }};
  {% endfor %}

  // Yì¶• ë°ì´í„°: Xì¶• íšŒì°¨ ìˆœì„œì— ë§ì¶°ì„œ ë§¤í•‘
  const ratings = episodeNos.map(no => ratingsMap[no]);
  const newsCounts = episodeNos.map(no => newsMap[no]);

  const ctx = document.getElementById('ratingChart').getContext('2d');

  const ratingChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: episodeNos.map(no => no + 'íšŒ'),
      datasets: [
        {
          label: 'ì‹œì²­ë¥  (%)',
          data: ratings,
          borderColor: 'blue',
          backgroundColor: 'rgba(0, 0, 255, 0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
          yAxisID: 'yRatings'
        },
        {
          label: 'ë‰´ìŠ¤ ìˆ˜',
          data: newsCounts,
          borderColor: 'orange',
          backgroundColor: 'rgba(255, 165, 0, 0.2)',
          fill: false,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
          yAxisID: 'yNews'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: function (context) {
              const index = context.dataIndex;
              const epNo = episodeNos[index];
              const date = airingDates[index];
              const val = context.dataset.data[index];
              if (context.dataset.label === 'ì‹œì²­ë¥  (%)') {
                return `ì‹œì²­ë¥ : ${val}% (${epNo}íšŒ, ${date})`;
              } else {
                return `ë‰´ìŠ¤ ìˆ˜: ${val} (${epNo}íšŒ, ${date})`;
              }
            }
          }
        }
      },
      interaction: {mode: 'index', intersect: false},
      onClick: (evt, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const epNo = episodeNos[index];
          const el = document.getElementById('episode-' + epNo);
          if (el) {
            el.scrollIntoView({behavior: 'smooth'});
            el.classList.add('highlight');
            setTimeout(() => {
              el.classList.remove('highlight');
            }, 1000);
          }
        }
      },
      scales: {
        yRatings: {
          type: 'linear',
          position: 'left',
          beginAtZero: true,
          title: {display: true, text: 'ì‹œì²­ë¥  (%)'}
        },
        yNews: {
          type: 'linear',
          position: 'right',
          beginAtZero: true,
          grid: {drawOnChartArea: false},
          title: {display: true, text: 'ë‰´ìŠ¤ ìˆ˜'}
        },
        x: {
          title: {display: true, text: 'íšŒì°¨'}
        }
      }
    }
  });
</script>
</body>
</html>
